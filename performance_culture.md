# 性能文化

> 原文：[Performance Culture](http://joeduffyblog.com/2016/04/10/performance-culture/)

在这篇文章中，我将讨论“性能文化”。性能是软件工程的关键支柱之一，也是很难做得正确的事情，有时候甚至很难去识别。一位著名的法官曾经说过：“当我看到时，我就知道。”之前我已经单独详细地谈到过[性能](http://joeduffyblog.com/2010/09/06/the-premature-optimization-is-evil-myth/)和[文化](http://joeduffyblog.com/2013/02/17/software-leadership-series/)，但两者的交集才是有意思的地方。这方面做得好的团队能在一开始就将性能贯彻到团队操作的几乎所有方面，并且能够主动提供迷人的用户体验来赢得竞争。没有简单的一刀切的方法来实现一个良好的性能文化，然而的确有一些最好的实践你可以遵循来播种到你的团队中。那，Let's go！

## 介绍

那么，为什么重点关注性能呢？

有部分原因是我的背景。我曾经工作在操作系统、runtime、编译器等东西上，都是一些客户期望能够很快的东西。相对于之后来修补，在此类项目的一开始就将目标、测量和团队进度从一开始就结合起来容易得多。我也曾经在很多团队工作过，一些在这方面做的非常棒，一些做得很差，而大多数是处于两者之间。一个统一的真相是区分的因素一直都是文化。

也有部分原因是因为，不管是什么类型的软件，性能几乎总是比我们客户期望的糟。这是一个简单的物理定律：给定有限的时间，以及在大小、速度以及功能的妥协，不可能加快程序的所有方面。但我坚信，在一般的团队中，对发展严谨的性能文化的关注度会比较低。我曾经听到过很多次“性能对于我们不是最优先”这样的话，直到痛苦地中止之后才认识到没有性能，产品不可能成功。

还有部分原因是它对于所有在 DevDiv 的我们就是信仰，因为我们聚焦于 .NET core 的性能、ASP.NET 的可伸缩性、整合促进性能的特性到 C# 和库中、使 Visual Studio 更快等等。它特别是我的信仰，因为我曾经一直和自己在 [Midori](./README.md) 中的经历比较（给这篇帖子带来了最多的启发）。

## 诊断和治疗

你如何辨别你的性能文化是在正轨上呢？这里有一些迹象表示它们不是的：

* 对“产品在我的关键性能指标上的执行情况怎么样？”这样的问题很难回答。
* 性能经常退步，而团队成员不是不知道、不关心，就是反应得太慢。
* 指责是对性能问题的最常见响应之一（对人员、基础结构，或者两者都是）。
* 性能测试狂野地摆动，不能被信任，因而被团队中的大多数人忽略。
* 性能是某些人或者某个人才会关注的东西，而不是整个团队。
* 产品中的性能问题很常见，需要进行丑陋乱糟糟的处理（和/或不能被重现）。

这看起来好像是技术问题。然而，你可能会惊讶，其实它们主要是人的问题。

解决方案并不容易，特别是当你的文化杂草丛生时。一开始就不要挖坑，总比后面再爬出来容易。但第一条规则是，当你已经在坑里，立刻停止继续挖！文化的转型必须从上层开始 —— 管理层在性能中积极参与，提出问题，寻求洞察，要求严谨 —— 同时它也来自下层 —— 工程师积极寻求了解他们正在编写的代码的性能，严酷地对退步采取零容忍的立场，并不断自我批评，寻找积极的改善。

除了我发现的一些一旦你拥有它就对效果很有帮助的最佳实践之外，本文将介绍一些方法来确保这种文化。它们中很多看起来很显而易见，但请相信我，很少能见到这里的这些东西在实践中和谐地生效。但一旦它可以生效，哇！那将会是多么的不同！

*对开源软件的简短说明：我是从商业软件开发的角度来写本文的。因此，你会比较多地看到“管理层”这词。许多同样的原则也在开源中起作用。所以，如果你喜欢，任何时候都可以将你看到的“管理层”在脑中转变成“管理人员或项目贡献者”。*

## 自此至终，文化随行

一个健康的性能文化的组成部分包括：

1. 性能是团队日常对话和“嗡嗡声”的一部分。每个人都参与了进来。
2. 管理层必须关心 —— 真正的，而不是肤浅的 —— 良好的性能，并理解它需要什么？
3. 工程师们对性能采取科学的、数据驱动的、刨根问底的方法。（测量，测量，测量！）
4. 鲁棒的工程系统处于恰当的位置，在追踪目标中，在过去和现在的性能中，并防止退步。

我会花一点时间来粗略地讨论这些问题。

### 对话、嗡嗡声和交流

整个团队需要挂钩到性能上。

在我看到的很多入了歧途的团队中，一个人被冠以去关注性能的家伙/姑娘。现在，那样做很好，可以帮助团队测量，当某些人需要带头调查时或大力提倡性能是很好时很有用，但这*绝不能*付出团队的其他人不牵涉进来的代价。

这会导致跟微软之前有的“测试”制度类似的问题：工程师学到了将他们代码的基本质量外包，期望着某个其他人会发现出现的问题的坏习惯。通常的风险也会出现，当有一个中心的性能沙皇时：团队中的工程师不会写代码测试，不会主动进行基准测试，不会分析，不会问关于产品有竞争力的地位的问题，也一般都不会干所有你需要所有的工程师做的能够建立一个健康的性能文化的事情。

当整个团队都痴迷于性能时，就会发生魔术般的事情。由于挑战和改善的消息是有机地传播的，走廊中充斥着兴奋。“你看到 Martin 的减少进程占用空间 30% 的哈希表再平衡改动了吗？”“Jared 刚刚签入了一个让你可以在栈上分配数组的特性。我打算在这个周末研究下网络栈来用上它 —— 有兴趣加入吗？”即兴白板会议、即兴构思、小组学习。看到这些真的很棒！激情和胜利的渴望自然地推动团队前进，不需依赖某些重量级的管理“大棒”。

我讨厌指责，我讨厌防备。我的第一原则是“不要蠢货（no jerks）”，所以自然地所有的批量都必须以最有建设性和尊重的方式来传达。然而，在性能上表现不佳的团队，我发现经常的责备、防备和知识[不诚实（ intellectual dishonesty）](http://joeduffyblog.com/2015/11/02/software-leadership-9-on-the-importance-of-intellectual-honesty/)。跟蠢货一样，这些都对团队的文化的毒害，必须大力清除。你发展正确的性能文化的能力很容易要么成功，要么失败。说我们需要在某些关键指标上做得更好，没有错，特别是如果你对如何做到这一点有好的想法！

在临时的沟通之外，当然也需要有结构化的沟通。稍后我会描述一些技巧。但，让一个核心组的人在一个房间里定期讨论对于产品特定领取过去、现在和未来的性能是必不可少的。虽然有机的对话是强大的，但每个人都很忙，所以安排时间作为提醒来推进很重要。

### 管理层：更多胡萝卜，更少棍子

每一个拥有很差性能文化的团队，都是管理层的错。句号。谈话结束。

当然，工程师们可以，也必须有所作为，但如果最上层的人和中层的每个人没有深度参与，安排必要的时间，并奖励工作和超级明星，那么正确的文化就不会出现。单独的工程师不可能将这种文化注入到整个团队中，整个努力都是逆流管理层而上是当然不行的。

看着不欣赏性能文化的管理层是痛苦的。他们经常被意外地扯后腿却不知道为什么 —— 或者更坏，认为这只是工程师需要坐的。（“我们不能预先预测性能在什么地方凑效！”）客户会抱怨产品不会在一些关键的领域表现得符合预期的效果，并且意识到预防措施太晚了，一个有糟糕性能文化的团队的管理人员会开始指责。猜下会发生什么？指责游戏像野火一样蔓延，工程师开始也这样做，问责制也就消失了。指责不会解决任何问题。指责是蠢货才会做的。

请注意，我说管理层必须“*深入*参与”：而不是一些肤浅的参与。当然，绿的红的趋势图可能需要在周围浮动，定期的检查也很重要。我想你会说这些是没几根头发的管理人员（pointy-haired manager）的事情。（相信我，即使如此他们也有帮助。）然而，管理人员必须做得更进一步，主动和定期地检查整个产品的性能状态，以及其他基本质量指标和特性方面的进展。这是团队工作的核心信条，必须这样对待。管理人员必须对竞争环境进行考量，并向团队提出好的有见地的问题，让他们思考。

性能不会从天下掉下来。它需要开销，强迫团队有时候放慢速度，把精力花在其他地方而不是赶功能，并因此需要一些聪明的权衡。到底有多少东西取决于这个场景？管理人员需要直到团队花费正确的时间比例。那些以为性能是免费的人最终会花费 2 至 5 倍多的它本应该花的成本，就在之后不适当的时间点（例如，在产品出货的最后阶段，在生产环境，试图从 1000 个客户扩展到 10 万，等等）。

我的一位导师曾经说：“你奖励了什么，你就会从团队中得到什么。”这对于性能和围绕着它们的工程系统特别正确。考虑两个管理人员：

* *管理人员 A* 对性能文化提供口头支持。但是，她将一个稳定的功能流打包到每个冲刺的时间安排中 —— “我们不得不粉碎竞争对手 Z 所以*必须*达到同等的功能！” —— 在这些冲刺之间没有任何时间休息。她使用全体团队会议来赞美新的功能、大量的演示，并甚至给获得“最具开创性功能”的每个工程师奖励。因此，她的团队将功能剪辑到一个令人印象深刻的剪辑中，每一次都向董事会提供新鲜的演示，并给销售团队追求新的可能提供大量的弹药。没有性能的门，工程师一般也不会费心想太多。

* 